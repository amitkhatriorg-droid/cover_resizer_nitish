<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RouteNote Cover Art Converter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
</head>
<body>

  <!-- Top Bar / Menu -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo-dot"></div>
        <div class="brand-text">
          <div class="brand-title">Cover Converter</div>
          <div class="brand-sub">RouteNote 3000×3000 • High Quality</div>
        </div>
      </div>

      <nav class="nav">
        <a class="nav-link" href="#" onclick="return false;">Home</a>
        <a class="nav-link" href="#" onclick="document.getElementById('help').scrollIntoView({behavior:'smooth'}); return false;">Help</a>
      </nav>
    </div>
  </header>

  <main class="page">
    <section class="hero">
      <h1>RouteNote Cover Art Converter</h1>
      <p>Manual crop adjust (drag & zoom) or Auto center-crop. Output always <strong>3000×3000</strong> JPEG with best-quality resizing on server.</p>
    </section>

    <section class="card">
      <div class="row row-gap">
        <div>
          <div class="label">Mode</div>
          <div class="seg" role="tablist" aria-label="Mode">
            <button id="modeAuto" class="seg-btn is-active" type="button">Auto</button>
            <button id="modeManual" class="seg-btn" type="button">Manual</button>
          </div>
          <div class="hint">Auto = center crop. Manual = adjust crop box yourself.</div>
        </div>

        <div class="right">
          <div class="label">Upload</div>
          <label class="file">
            <input id="fileInput" type="file" accept="image/*">
            <span id="fileName" class="file-name">Choose an image…</span>
            <span class="file-btn">Browse</span>
          </label>
          <div class="hint">Best results: upload a large image.</div>
        </div>
      </div>

      <!-- Manual Crop Panel -->
      <div id="manualPanel" class="manual-panel" style="display:none;">
        <div class="panel-head">
          <div>
            <div class="panel-title">Manual Crop</div>
            <div class="panel-sub">Drag to move • Scroll/pinch to zoom • Keep framing inside the square</div>
          </div>
          <button id="btnReset" class="btn btn-ghost" type="button" disabled>Reset</button>
        </div>

        <div class="crop-frame">
          <img id="preview" alt="preview" style="display:none; max-width:100%;">
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="btnConvert" class="btn btn-primary" type="button" disabled>Convert & Download</button>
        <div id="status" class="status" aria-live="polite"></div>
      </div>

      <div class="note">
        <div class="note-title">Quality note</div>
        <ul>
          <li>Browser side: only cropping (no 3000 resize).</li>
          <li>Server side: 3000×3000 resize using <strong>LANCZOS</strong> (best quality).</li>
          <li>JPEG exported in high quality.</li>
        </ul>
      </div>
    </section>

    <section id="help" class="help">
      <h2>Quick Help</h2>
      <div class="help-grid">
        <div class="help-card">
          <div class="help-title">Auto Mode</div>
          <div class="help-text">Upload → Convert. Center crop automatically.</div>
        </div>
        <div class="help-card">
          <div class="help-title">Manual Mode</div>
          <div class="help-text">Upload → Adjust crop square → Convert.</div>
        </div>
        <div class="help-card">
          <div class="help-title">If image looks blurry</div>
          <div class="help-text">Upload a higher-resolution artwork (bigger than 3000×3000).</div>
        </div>
      </div>
    </section>

    <footer class="footer">
      © 2026 Cover Converter
    </footer>
  </main>

  <!-- Cropper.js -->
  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');

    const modeAutoBtn = document.getElementById('modeAuto');
    const modeManualBtn = document.getElementById('modeManual');

    const manualPanel = document.getElementById('manualPanel');
    const preview = document.getElementById('preview');

    const btnReset = document.getElementById('btnReset');
    const btnConvert = document.getElementById('btnConvert');
    const statusEl = document.getElementById('status');

    let mode = 'auto';            // 'auto' | 'manual'
    let cropper = null;
    let selectedFile = null;

    function setMode(nextMode) {
      mode = nextMode;

      modeAutoBtn.classList.toggle('is-active', mode === 'auto');
      modeManualBtn.classList.toggle('is-active', mode === 'manual');

      if (!selectedFile) {
        manualPanel.style.display = (mode === 'manual') ? 'block' : 'none';
        return;
      }

      if (mode === 'manual') {
        manualPanel.style.display = 'block';
        initCropperFromFile(selectedFile);
      } else {
        manualPanel.style.display = 'none';
        destroyCropper();
      }

      statusEl.textContent = '';
    }

    function destroyCropper() {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      preview.style.display = 'none';
      btnReset.disabled = true;
    }

    function initCropperFromFile(file) {
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.style.display = 'block';

      preview.onload = () => {
        destroyCropper();
        cropper = new Cropper(preview, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 1,
          background: false,
          guides: true,
          center: true,
          movable: true,
          zoomable: true,
          rotatable: false,
          scalable: false,
          responsive: true
        });
        btnReset.disabled = false;
      };
    }

    modeAutoBtn.addEventListener('click', () => setMode('auto'));
    modeManualBtn.addEventListener('click', () => setMode('manual'));

    fileInput.addEventListener('change', () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      selectedFile = file;
      fileName.textContent = file.name || 'Selected image';
      btnConvert.disabled = false;
      statusEl.textContent = '';

      if (mode === 'manual') {
        manualPanel.style.display = 'block';
        initCropperFromFile(file);
      } else {
        manualPanel.style.display = 'none';
        destroyCropper();
      }
    });

    btnReset.addEventListener('click', () => {
      if (cropper) cropper.reset();
    });

    async function postAndDownload(blobOrFile, filename) {
      const formData = new FormData();
      formData.append('cover', blobOrFile, filename);

      const resp = await fetch('{{ url_for("convert") }}', {
        method: 'POST',
        body: formData
      });

      if (!resp.ok) throw new Error('Server error: ' + resp.status);

      const outBlob = await resp.blob();
      const outUrl = URL.createObjectURL(outBlob);

      const a = document.createElement('a');
      a.href = outUrl;
      a.download = 'routenote_3000x3000.jpg';
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(outUrl);
    }

    btnConvert.addEventListener('click', async () => {
      if (!selectedFile) return;

      btnConvert.disabled = true;
      statusEl.textContent = 'Processing…';

      try {
        if (mode === 'auto') {
          // Auto: send original file; server does center-crop + LANCZOS resize
          await postAndDownload(selectedFile, selectedFile.name || 'cover.png');
          statusEl.textContent = 'Done ✅ Download started.';
        } else {
          // Manual: crop only (no client resize) then send to server for LANCZOS resize
          if (!cropper) throw new Error('Cropper not ready. Try again.');

          cropper.getCroppedCanvas().toBlob(async (blob) => {
            try {
              await postAndDownload(blob, 'cropped.png');
              statusEl.textContent = 'Done ✅ Download started.';
            } catch (e) {
              statusEl.textContent = 'Error: ' + e.message;
            } finally {
              btnConvert.disabled = false;
            }
          }, 'image/png');

          return; // because toBlob is async callback
        }
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
      } finally {
        if (mode === 'auto') btnConvert.disabled = false;
      }
    });

    // default mode
    setMode('auto');
  </script>
</body>
</html>
