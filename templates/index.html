<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cover Converter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
</head>
<body>

  <main class="wrap">
    <header class="hdr">
      <div class="brand">
        <span class="dot"></span>
        <div class="name">Cover Converter</div>
      </div>
      <div class="pill">3000×3000</div>
    </header>

    <section class="card">
      <div class="seg" role="tablist" aria-label="Mode">
        <button id="modeAuto" class="segBtn isOn" type="button">Auto</button>
        <button id="modeManual" class="segBtn" type="button">Manual</button>
      </div>

      <label class="upload" for="fileInput">
        <div class="uLeft">
          <div class="uLabel">Upload</div>
          <div id="fileName" class="uName">Tap to choose image…</div>
        </div>
        <div class="uBtn">Browse</div>
      </label>
      <input id="fileInput" type="file" accept="image/*">

      <button id="btnConvert" class="btn" type="button" disabled>Convert & Download</button>
      <div id="status" class="status" aria-live="polite"></div>
    </section>
  </main>

  <!-- Fullscreen crop modal (Manual only) -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="mTop">
      <button id="mClose" class="mIcon" type="button" aria-label="Close">✕</button>
      <div class="mTitle">Crop</div>
      <button id="mDone" class="mIcon mPrimary" type="button">Done</button>
    </div>

    <div class="mBody">
      <div class="stage">
        <img id="cropImg" alt="crop">
      </div>
    </div>

    <div class="mBottom">
      <button id="zOut" class="mBtn" type="button">−</button>
      <button id="zIn" class="mBtn" type="button">+</button>
      <button id="mReset" class="mBtn" type="button">Reset</button>
    </div>
  </div>

  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const fileName  = document.getElementById('fileName');
    const statusEl  = document.getElementById('status');
    const btnConvert= document.getElementById('btnConvert');

    const modeAuto  = document.getElementById('modeAuto');
    const modeManual= document.getElementById('modeManual');

    const modal  = document.getElementById('modal');
    const cropImg= document.getElementById('cropImg');
    const mClose = document.getElementById('mClose');
    const mDone  = document.getElementById('mDone');
    const zIn    = document.getElementById('zIn');
    const zOut   = document.getElementById('zOut');
    const mReset = document.getElementById('mReset');

    let mode = 'auto';
    let selectedFile = null;
    let cropper = null;
    let manualBlob = null; // cropped PNG (NO resize in browser)

    function setMode(next){
      mode = next;
      modeAuto.classList.toggle('isOn', mode === 'auto');
      modeManual.classList.toggle('isOn', mode === 'manual');
      manualBlob = null;
      statusEl.textContent = '';
    }

    function openModal(){
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      document.body.classList.add('noScroll');
    }
    function closeModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      document.body.classList.remove('noScroll');
    }
    function destroyCropper(){
      if(cropper){ cropper.destroy(); cropper = null; }
    }
    function initCropper(file){
      const url = URL.createObjectURL(file);
      cropImg.src = url;
      cropImg.onload = () => {
        destroyCropper();
        cropper = new Cropper(cropImg, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 1,
          background: false,
          guides: false,
          center: true,
          movable: true,
          zoomable: true,
          rotatable: false,
          scalable: false,
          responsive: true,
          toggleDragModeOnDblclick: false
        });
      };
    }

    async function postAndDownload(blobOrFile, filename){
      const formData = new FormData();
      formData.append('cover', blobOrFile, filename);

      const resp = await fetch('{{ url_for("convert") }}', { method:'POST', body: formData });
      if(!resp.ok) throw new Error('Server error: ' + resp.status);

      const outBlob = await resp.blob();
      const outUrl = URL.createObjectURL(outBlob);

      const a = document.createElement('a');
      a.href = outUrl;
      a.download = 'routenote_3000x3000.jpg';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(outUrl);
    }

    modeAuto.addEventListener('click', () => setMode('auto'));
    modeManual.addEventListener('click', () => setMode('manual'));

    fileInput.addEventListener('change', () => {
      const file = fileInput.files && fileInput.files[0];
      if(!file) return;

      selectedFile = file;
      fileName.textContent = file.name || 'Selected image';
      btnConvert.disabled = false;
      statusEl.textContent = '';
      manualBlob = null;

      if(mode === 'manual'){
        openModal();
        initCropper(file);
      }
    });

    mClose.addEventListener('click', () => closeModal());
    zIn.addEventListener('click', () => cropper && cropper.zoom(0.12));
    zOut.addEventListener('click', () => cropper && cropper.zoom(-0.12));
    mReset.addEventListener('click', () => cropper && cropper.reset());

    mDone.addEventListener('click', () => {
      if(!cropper) return;
      cropper.getCroppedCanvas().toBlob((blob) => {
        manualBlob = blob;
        closeModal();
        statusEl.textContent = 'Saved ✓';
      }, 'image/png');
    });

    btnConvert.addEventListener('click', async () => {
      if(!selectedFile) return;

      btnConvert.disabled = true;
      statusEl.textContent = 'Working…';

      try{
        if(mode === 'auto'){
          await postAndDownload(selectedFile, selectedFile.name || 'cover.png');
          statusEl.textContent = 'Downloaded ✓';
        } else {
          if(!manualBlob){
            openModal();
            initCropper(selectedFile);
            statusEl.textContent = '';
            btnConvert.disabled = false;
            return;
          }
          await postAndDownload(manualBlob, 'cropped.png');
          statusEl.textContent = 'Downloaded ✓';
        }
      } catch(e){
        statusEl.textContent = 'Error';
      } finally {
        btnConvert.disabled = false;
      }
    });

    setMode('auto');
  </script>
</body>
</html>
