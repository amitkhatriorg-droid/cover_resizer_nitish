<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cover Converter • RouteNote 3000×3000</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Cropper.js -->
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
</head>
<body>

  <header class="topbar">
    <div class="wrap topbar-inner">
      <div class="brand">
        <span class="logo"></span>
        <div>
          <div class="brand-title">Cover Converter</div>
          <div class="brand-sub">RouteNote • 3000×3000 • High Quality</div>
        </div>
      </div>
      <a class="chip" href="#" onclick="document.getElementById('how').scrollIntoView({behavior:'smooth'});return false;">How it works</a>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <h1>Make perfect cover art in seconds</h1>
      <p>Choose <strong>Auto</strong> (center crop) or <strong>Manual</strong> (easy full-screen crop on mobile). Output is always a high-quality <strong>3000×3000 JPEG</strong>.</p>
    </section>

    <section class="panel">
      <div class="row">
        <div class="col">
          <div class="label">Mode</div>
          <div class="seg" role="tablist" aria-label="Mode">
            <button id="btnModeAuto" class="seg-btn is-on" type="button">Auto</button>
            <button id="btnModeManual" class="seg-btn" type="button">Manual</button>
          </div>
          <div class="sub">Manual mode opens a full-screen crop screen with big controls.</div>
        </div>

        <div class="col">
          <div class="label">Upload</div>
          <label class="filebox" for="fileInput">
            <span id="fileText" class="filetext">Tap to choose an image…</span>
            <span class="filebtn">Browse</span>
          </label>
          <input id="fileInput" type="file" accept="image/*" />
          <div class="sub">Best results: use artwork larger than 3000×3000.</div>
        </div>
      </div>

      <div class="actionbar">
        <button id="btnConvert" class="btn btn-primary" type="button" disabled>Convert & Download</button>
        <div id="status" class="status" aria-live="polite"></div>
      </div>
    </section>

    <section id="how" class="info">
      <h2>Quality-focused workflow</h2>
      <ul>
        <li><strong>Auto:</strong> upload → server center-crops + resizes with LANCZOS.</li>
        <li><strong>Manual:</strong> you crop (no resize in browser) → server resizes with LANCZOS.</li>
        <li>Export: high-quality JPEG download.</li>
      </ul>
    </section>

    <footer class="foot">© 2026 Cover Converter</footer>
  </main>

  <!-- Full-screen Crop Modal (Mobile Friendly) -->
  <div id="cropModal" class="modal" aria-hidden="true">
    <div class="modal-top">
      <button id="btnCloseCrop" class="iconbtn" type="button" aria-label="Close">✕</button>
      <div class="modal-title">
        <div class="t1">Adjust Crop</div>
        <div class="t2">Drag to move • Pinch to zoom • Use buttons if needed</div>
      </div>
      <button id="btnDoneCrop" class="iconbtn primary" type="button">Done</button>
    </div>

    <div class="modal-body">
      <div class="crop-stage">
        <img id="cropImage" alt="Crop preview" />
      </div>
    </div>

    <div class="modal-bottom">
      <button id="btnZoomOut" class="btn btn-soft" type="button">Zoom −</button>
      <button id="btnZoomIn" class="btn btn-soft" type="button">Zoom +</button>
      <button id="btnReset" class="btn btn-soft" type="button">Reset</button>
    </div>
  </div>

  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>

  <script>
    const fileInput   = document.getElementById('fileInput');
    const fileText    = document.getElementById('fileText');
    const statusEl    = document.getElementById('status');
    const btnConvert  = document.getElementById('btnConvert');

    const btnModeAuto   = document.getElementById('btnModeAuto');
    const btnModeManual = document.getElementById('btnModeManual');

    // Modal elements
    const cropModal   = document.getElementById('cropModal');
    const cropImage   = document.getElementById('cropImage');
    const btnCloseCrop = document.getElementById('btnCloseCrop');
    const btnDoneCrop  = document.getElementById('btnDoneCrop');

    const btnZoomIn  = document.getElementById('btnZoomIn');
    const btnZoomOut = document.getElementById('btnZoomOut');
    const btnReset   = document.getElementById('btnReset');

    let mode = 'auto';
    let selectedFile = null;
    let cropper = null;
    let manualBlob = null; // cropped (PNG) blob from manual mode

    function setMode(next) {
      mode = next;
      btnModeAuto.classList.toggle('is-on', mode === 'auto');
      btnModeManual.classList.toggle('is-on', mode === 'manual');
      manualBlob = null;
      statusEl.textContent = '';
    }

    function openModal() {
      cropModal.classList.add('open');
      cropModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('noscroll');
    }

    function closeModal() {
      cropModal.classList.remove('open');
      cropModal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('noscroll');
    }

    function destroyCropper() {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
    }

    function initCropper(file) {
      const url = URL.createObjectURL(file);
      cropImage.src = url;

      cropImage.onload = () => {
        destroyCropper();
        cropper = new Cropper(cropImage, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 1,
          background: false,
          responsive: true,
          movable: true,
          zoomable: true,
          guides: false,
          center: true,
          highlight: false,
          toggleDragModeOnDblclick: false
        });
      };
    }

    async function postAndDownload(blobOrFile, filename) {
      const formData = new FormData();
      formData.append('cover', blobOrFile, filename);

      const resp = await fetch('{{ url_for("convert") }}', { method: 'POST', body: formData });
      if (!resp.ok) throw new Error('Server error: ' + resp.status);

      const outBlob = await resp.blob();
      const outUrl = URL.createObjectURL(outBlob);

      const a = document.createElement('a');
      a.href = outUrl;
      a.download = 'routenote_3000x3000.jpg';
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(outUrl);
    }

    // Mode buttons
    btnModeAuto.addEventListener('click', () => setMode('auto'));
    btnModeManual.addEventListener('click', () => setMode('manual'));

    // File selection
    fileInput.addEventListener('change', () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      selectedFile = file;
      fileText.textContent = file.name || 'Selected image';
      btnConvert.disabled = false;
      statusEl.textContent = '';
      manualBlob = null;

      if (mode === 'manual') {
        openModal();
        initCropper(file);
      }
    });

    // Modal controls
    btnCloseCrop.addEventListener('click', () => {
      closeModal();
    });

    btnZoomIn.addEventListener('click', () => { if (cropper) cropper.zoom(0.08); });
    btnZoomOut.addEventListener('click', () => { if (cropper) cropper.zoom(-0.08); });
    btnReset.addEventListener('click', () => { if (cropper) cropper.reset(); });

    btnDoneCrop.addEventListener('click', () => {
      if (!cropper) return;

      // IMPORTANT: only crop here (no 3000 resize in browser)
      cropper.getCroppedCanvas().toBlob((blob) => {
        manualBlob = blob; // store for convert
        closeModal();
        statusEl.textContent = 'Crop saved ✅ Now tap Convert & Download.';
      }, 'image/png');
    });

    // Convert
    btnConvert.addEventListener('click', async () => {
      if (!selectedFile) return;

      btnConvert.disabled = true;
      statusEl.textContent = 'Processing…';

      try {
        if (mode === 'auto') {
          await postAndDownload(selectedFile, selectedFile.name || 'cover.png');
        } else {
          // If user didn’t press Done, open modal to confirm crop
          if (!manualBlob) {
            openModal();
            initCropper(selectedFile);
            statusEl.textContent = 'Adjust crop and tap Done.';
            btnConvert.disabled = false;
            return;
          }
          await postAndDownload(manualBlob, 'cropped.png');
        }

        statusEl.textContent = 'Done ✅ Download started.';
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
      } finally {
        btnConvert.disabled = false;
      }
    });

    setMode('auto');
  </script>
</body>
</html>
