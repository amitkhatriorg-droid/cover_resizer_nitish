<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cover Art Converter</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="app-container">
        <h1 class="app-title">ArtConverter <span>Pro</span></h1>

        <div class="mode-toggle">
            <input type="radio" name="mode" id="mode-auto" value="auto" checked onchange="setMode('auto')">
            <label for="mode-auto">Auto Center</label>
            
            <input type="radio" name="mode" id="mode-manual" value="manual" onchange="setMode('manual')">
            <label for="mode-manual">Manual Crop</label>
            <div class="toggle-bg"></div>
        </div>

        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept="image/*" hidden>
            <div class="upload-content">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <p id="fileName">Tap to Upload Artwork</p>
                <span class="file-info">Supports JPG, PNG</span>
            </div>
        </div>

        <button id="convertBtn" class="primary-btn" disabled onclick="processConversion()">
            Convert & Download
        </button>

        <div id="statusText" class="status-text"></div>
    </div>

    <div id="cropModal" class="crop-modal">
        <div class="crop-container">
            <img id="cropImage" src="">
        </div>
        
        <div class="crop-toolbar">
            <div class="crop-controls">
                <button onclick="cropper.zoom(-0.1)" class="tool-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                </button>
                <button onclick="cropper.reset()" class="tool-btn">
                   <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                </button>
                <button onclick="cropper.zoom(0.1)" class="tool-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                </button>
            </div>
            <div class="crop-actions">
                <button onclick="closeModal()" class="cancel-btn">Cancel</button>
                <button onclick="finishCrop()" class="done-btn">Done</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script>
        let currentMode = 'auto';
        let currentFile = null;
        let cropper = null;
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const statusText = document.getElementById('statusText');
        const fileNameDisplay = document.getElementById('fileName');
        const cropImage = document.getElementById('cropImage');
        const cropModal = document.getElementById('cropModal');

        function setMode(mode) {
            currentMode = mode;
            // Reset if switching modes
            currentFile = null;
            fileInput.value = '';
            convertBtn.disabled = true;
            fileNameDisplay.innerText = "Tap to Upload Artwork";
            statusText.innerText = '';
        }

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (currentMode === 'auto') {
                currentFile = file;
                fileNameDisplay.innerText = file.name;
                convertBtn.disabled = false;
                convertBtn.innerHTML = "Convert & Download";
                statusText.innerText = "Ready to convert";
            } else {
                // Manual Mode: Open Modal
                const reader = new FileReader();
                reader.onload = function(event) {
                    cropImage.src = event.target.result;
                    openModal();
                };
                reader.readAsDataURL(file);
            }
        });

        function openModal() {
            cropModal.style.display = 'flex';
            // Init Cropper
            if(cropper) cropper.destroy();
            cropper = new Cropper(cropImage, {
                aspectRatio: 1,
                viewMode: 1,
                dragMode: 'move', // Move image, not crop box
                autoCropArea: 1,  // Maximize crop box
                restore: false,
                guides: false,
                center: true,
                highlight: false,
                cropBoxMovable: false, // Force user to move image
                cropBoxResizable: false,
                toggleDragModeOnDblclick: false,
            });
        }

        function closeModal() {
            cropModal.style.display = 'none';
            fileInput.value = ''; // Reset input
            if(cropper) cropper.destroy();
        }

        function finishCrop() {
            // Get cropped canvas (high quality)
            cropper.getCroppedCanvas().toBlob((blob) => {
                currentFile = blob;
                // Add a filename property to blob for UX
                currentFile.name = "cropped-image.png";
                
                fileNameDisplay.innerText = "Image Cropped & Ready";
                convertBtn.disabled = false;
                statusText.innerText = "Ready to convert";
                
                cropModal.style.display = 'none';
                if(cropper) cropper.destroy();
            }, 'image/png');
        }

        async function processConversion() {
            if (!currentFile) return;

            convertBtn.disabled = true;
            convertBtn.innerHTML = "Processing...";
            statusText.innerText = "Uploading & Converting...";
            statusText.className = "status-text";

            const formData = new FormData();
            formData.append('file', currentFile, currentFile.name || 'image.png');

            try {
                const response = await fetch('/convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Conversion failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'cover_3000x3000.jpg';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                statusText.innerText = "Done! Downloading...";
                statusText.classList.add('success');
                convertBtn.innerHTML = "Convert Another";
            } catch (error) {
                console.error(error);
                statusText.innerText = "Error: Conversion failed.";
                statusText.classList.add('error');
            } finally {
                convertBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
